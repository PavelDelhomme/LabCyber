# Lab Cyber â€“ Multi-instances (sans container_name pour permettre plusieurs labs)
# Usage : GATEWAY_PORT=8081 COMPOSE_PROJECT_NAME=lab-8081 docker compose -f docker-compose.multi.yml up -d
# Puis : ./lab up 8081  et  ./lab down 8081

services:
  gateway:
    build: ./gateway
    ports: ["${GATEWAY_PORT:-8080}:80"]
    networks: [lab-network]
    depends_on: [platform]

  platform:
    build:
      context: .
      dockerfile: platform/Dockerfile
    networks: [lab-network]
    expose: ["80"]

  attaquant:
    build: ./attacker
    networks: [lab-network]
    ports: ["${TTYD_PORT:-7681}:7681"]
    expose: ["7681"]
    stdin_open: true
    tty: true

  dvwa:
    image: cytopia/dvwa:latest
    networks:
      lab-network:
        aliases: [dvwa]
    expose: ["80"]
    environment:
      - MYSQL_HOSTNAME=dvwa-db
      - MYSQL_DATABASE=dvwa
      - MYSQL_USERNAME=dvwa
      - MYSQL_PASSWORD=p@ssw0rd
    depends_on: [dvwa-db]

  dvwa-db:
    image: mariadb:10
    networks: [lab-network]
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=p@ssw0rd
    volumes: [dvwa-db-data:/var/lib/mysql]

  juice-shop:
    image: bkimminich/juice-shop:latest
    networks:
      lab-network:
        aliases: [juice-shop]
    expose: ["3000"]

  bwapp:
    image: raesene/bwapp:latest
    networks:
      lab-network:
        aliases: [bwapp]
    expose: ["80"]

  vuln-network:
    build: ./vuln-network
    networks:
      lab-network:
        aliases: [vuln-network, vulnbox]
    expose: ["22", "6379"]

  vuln-api:
    build: ./vuln-api
    networks:
      lab-network:
        aliases: [vuln-api, api]
    expose: ["5000"]
    volumes: [vuln-api-data:/data]

  blue-suricata:
    image: jasonish/suricata:latest
    networks: [lab-network]
    volumes:
      - suricata-logs:/var/log/suricata
      - suricata-pcaps:/workspace
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]
    profiles: [blue]

  proxy:
    image: ubuntu/squid:latest
    networks: [lab-network]
    ports: ["3128:3128"]
    volumes: ["./proxy/squid.conf:/etc/squid/squid.conf:ro"]
    profiles: [proxy]

volumes:
  dvwa-db-data:
  vuln-api-data:
  suricata-logs:
  suricata-pcaps:

networks:
  lab-network:
    driver: bridge
