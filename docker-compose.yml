# Lab Cyber – Gateway (plateforme + cibles) + Terminal (ttyd) sur port dédié
# Plateforme : GATEWAY_PORT (défaut 8080) → http://127.0.0.1:8080
# Terminal   : 7681 → http://localhost:7681 (lancer le terminal direct)
# /etc/hosts optionnel : 127.0.0.1 lab.local dvwa.lab juice.lab api.lab bwapp.lab terminal.lab

services:
  # ========== GATEWAY (plateforme + cibles sur ce port) ==========
  gateway:
    build: ./gateway
    container_name: lab-gateway
    ports: ["${GATEWAY_PORT:-8080}:80"]
    networks: [lab-network]
    depends_on:
      platform: { condition: service_started }
      attaquant: { condition: service_healthy }
      desktop: { condition: service_healthy }

  # ========== Plateforme web (accès via gateway) ==========
  platform:
    build:
      context: .
      dockerfile: platform/Dockerfile
    container_name: lab-platform
    networks: [lab-network]
    expose: ["80"]

  # ========== Terminal web : http://localhost:TTYD_PORT (ttyd) ==========
  attaquant:
    build: ./attacker
    container_name: lab-attaquant
    networks: [lab-network]
    ports: ["${TTYD_PORT:-7681}:7681"]
    expose: ["7681"]
    stdin_open: true
    tty: true
    healthcheck:
      # OK si ttyd répond ; sinon OK si ttyd absent (autre arch) pour ne pas bloquer la gateway
      test: ["CMD", "sh", "-c", "wget -q -O /dev/null http://127.0.0.1:7681/ || [ ! -x /usr/local/bin/ttyd ]"]
      interval: 5s
      timeout: 3s
      retries: 8
      start_period: 20s

  # ========== WEB (accès via gateway par hostname) ==========
  dvwa:
    image: cytopia/dvwa:latest
    container_name: lab-dvwa
    networks:
      lab-network:
        aliases: [dvwa]
    expose: ["80"]
    environment:
      - MYSQL_HOSTNAME=dvwa-db
      - MYSQL_DATABASE=dvwa
      - MYSQL_USERNAME=dvwa
      - MYSQL_PASSWORD=p@ssw0rd
      # Supprime le warning Apache "Could not reliably determine the server's fully qualified domain name"
      # (si le warning persiste, l'image peut ne pas utiliser cette variable ; ignorable.)
      - APACHE_SERVER_NAME=dvwa.lab
    depends_on: [dvwa-db]

  dvwa-db:
    image: mariadb:10
    container_name: lab-dvwa-db
    networks: [lab-network]
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=p@ssw0rd
    volumes: [dvwa-db-data:/var/lib/mysql]

  juice-shop:
    image: bkimminich/juice-shop:latest
    container_name: lab-juice-shop
    networks:
      lab-network:
        aliases: [juice-shop]
    expose: ["3000"]

  bwapp:
    build: ./bwapp
    image: labcyber-bwapp:latest
    container_name: lab-bwapp
    networks:
      lab-network:
        aliases: [bwapp]
    expose: ["80"]

  # ========== RÉSEAU (SSH/Redis accessibles uniquement depuis le lab, ex. attaquant) ==========
  vuln-network:
    build: ./vuln-network
    container_name: lab-vuln-network
    networks:
      lab-network:
        aliases: [vuln-network, vulnbox]
    expose: ["22", "6379"]
    # Note: si Redis affiche "Memory overcommit must be enabled", sur l'hôte : sudo sysctl vm.overcommit_memory=1

  # ========== API (accès via gateway → api.lab) ==========
  vuln-api:
    build: ./vuln-api
    container_name: lab-vuln-api
    networks:
      lab-network:
        aliases: [vuln-api, api]
    expose: ["5000"]
    volumes: [vuln-api-data:/data]

  # ========== BLUE TEAM ==========
  blue-suricata:
    image: jasonish/suricata:latest
    container_name: lab-suricata
    networks: [lab-network]
    volumes:
      - suricata-logs:/var/log/suricata
      - suricata-pcaps:/workspace
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]
    profiles: [blue]

  # ========== Bureau noVNC (XFCE, accès via /desktop/) ==========
  # accetto : noVNC + websockify sur 6901. Gateway attend que le bureau réponde (healthcheck).
  desktop:
    image: accetto/ubuntu-vnc-xfce:latest
    container_name: lab-desktop
    networks: [lab-network]
    expose: ["6901"]
    environment:
      - VNC_PW=labcyber
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:6901/"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  # ========== PROXY Squid (profil proxy ; port exposé si besoin) ==========
  proxy:
    image: ubuntu/squid:latest
    container_name: lab-proxy
    networks: [lab-network]
    ports: ["3128:3128"]
    volumes: ["./proxy/squid.conf:/etc/squid/squid.conf:ro"]
    profiles: [proxy]

volumes:
  dvwa-db-data:
  vuln-api-data:
  suricata-logs:
  suricata-pcaps:

networks:
  lab-network:
    driver: bridge
    name: lab-network
